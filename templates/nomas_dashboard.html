<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rubiqs | NoMas Training Dashboard</title>
  <!-- Uses your shared styles -->
  <style>
    .form-group.third {
      flex: 1 1 32%;
    }

    .form-control {
      width: 100%;
      height: 42px;
      padding: 0.6rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(to right, #f1e2c4, #5ca198, #1f3a54);
      color: #1f3a54;
      margin: 0;
      padding: 2rem;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .card {
      background: white;
      padding: 2rem;
      width: 100%;
      max-width: 1000px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    h2.title {
      text-align: center;
      font-size: 1.75rem;
      font-weight: bold;
      margin-bottom: 1.5rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      border-bottom: 1px solid #ccc;
      margin-bottom: 1.5rem;
    }

    .tab-button {
      padding: 0.6rem 1.2rem;
      background: #eee;
      border: none;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      color: #1f3a54;
      font-size: 0.95rem;
    }

    .tab-button.active {
      background: white;
      border: 1px solid #ccc;
      border-bottom: none;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-group.third {
      flex: 1 1 32%;
    }

    .form-group {
      flex: 1 1 48%;
    }

    .wide {
      flex: 1 1 100%;
    }

    label {
      font-weight: bold;
      margin-bottom: 0.3rem;
      display: block;
    }

    input[type="text"],
    input[type="file"],
    select,
    textarea {
      width: 100%;
      padding: 0.6rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    textarea {
      resize: vertical;
    }

    .require-toggle {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-direction: column;
    }

    .toggle-option {
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
    }

    .toggle-option.active {
      background-color: #1f3a54;
      color: white;
      border-color: #1f3a54;
    }

    .instruction-note {
      font-size: 0.85rem;
      color: #555;
      margin-top: 0.3rem;
    }

    button.submit {
      display: block;
      margin: 2rem auto 0 auto;
      background: #1f3a54;
      color: white;
      padding: 0.85rem 2rem;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 40px;
      cursor: pointer;
      transition: background 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    button.submit:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    button.submit:hover:not(:disabled) {
      background: #142835;
    }

    .logo {
      max-height: 80px;
      width: auto;
      margin-right: 1.5rem;
    }
  
.submit-button.danger {
  background-color: #dc2626;
  color: white;
  padding: 0.4rem 0.75rem;
  font-size: 0.9rem;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  display: inline-block;
}

.submit-button.danger:hover {
  background-color: #b91c1c;
}

.card-body {
  width: 100%;
}

.submit-button:hover {
  background-color: #142835;
  color: white;
}

.tab-panel.active { display: block !important; }



  </style>
</head>
<body>
  <div class="card">
    <h2 class="title">NoMas Training Dashboard</h2>
    <div style="text-align: right; margin-bottom: 1rem;">
      <a href="/grader-base" class="submit-button" style="background-color: #1f3a54; color: white; padding: 0.6rem 1.25rem; font-size: 0.9rem; border-radius: 8px; display: inline-block; margin-bottom: 1rem;">
        ‚Üê Back to Rubiqs Grader Dashboard
      </a>
    </div>

    <div class="tabs">
      <button type="button" class="tab-button active" data-target="generate">Generate Answer Key</button>
      <button type="button" class="tab-button" data-target="create">Create NoMas Assignment</button>
      <button type="button" class="tab-button" data-target="manage">Edit NoMas Assignments</button>
      <button type="button" class="tab-button" data-target="submissions">View NoMas Submissions</button>
    </div>

    <!-- === TAB 1: Generate Answer Key === -->
    <div id="generate" class="tab-panel active card-body">
      <div style="background-color: #2d4b68; color: white; padding: 1rem 1.25rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <h4 style="margin-top: 0; margin-bottom: 0.75rem;">Step 1: Generate the Answer Key</h4>
        <ul style="padding-left: 1.2rem; margin: 0;">
          <li style="margin-bottom: 0.5rem;">Upload a correctly filled-out USCIS form (PDF) and click <strong>Generate Answer Key</strong>.</li>
          <li style="margin-bottom: 0.5rem;">This will create a JSON answer key and automatically apply it to the correct field on the <strong>Create USCIS Assignment</strong> panel.</li>
          <li style="margin-bottom: 0.5rem;">After generating the key, complete the assignment setup on the <strong>Create USCIS Assignment</strong> panel.</li>
          <li><em>This step must be completed before setting up the assignment.</em></li>
        </ul>
      </div>

      <form action="/generate-answer-key" method="POST" enctype="multipart/form-data">
        <div class="row" style="margin-bottom: 1.5rem;">
          <div class="form-group wide">
            <label for="form_pdf">Upload Filled Form PDF</label>
            <input type="file" name="file" id="form_pdf" accept=".pdf" required>
          </div>
        </div>

        <div class="row">
          <div class="form-group wide">
            <button type="submit" class="submit">Generate Answer Key</button>
          </div>
        </div>
      </form>
    </div>

    <!-- === TAB 2: Create NoMas Assignment === -->
    <div id="create" class="tab-panel card-body">
      <form action="/create-uscis-assignment" method="POST" enctype="multipart/form-data">
        <div class="row">
          <div class="form-group">
            <label for="title">Assignment Title</label>
            <input type="text" id="title" name="title" required>
          </div>

          <div class="form-group">
            <label for="form_type">Form Type</label>
            <select name="form_type" id="form_type">
              <option value="n400">N-400 (Naturalization)</option>
              <option value="i765">I-765 (Work Authorization)</option>
              <option value="i130a">I-130A (Spouse of US Citizen)</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="rubric_file_url">Answer Key (JSON):</label>
          <input type="url" name="rubric_file_url" id="rubric_file_url" class="form-control">
        </div>

        <div class="form-group">
          <label for="answer_key_upload">Or Upload Answer Key File (JSON)</label>
          <input type="file" name="answer_key_upload" id="answer_key_upload" accept=".json" class="form-control">
        </div>

        <div class="row">
          <div class="form-group wide require-toggle" style="flex-direction: row; align-items: center;">
            <label style="margin-right: 1rem; white-space: nowrap;">Requires Instructor Review</label>
            <div style="display: flex; gap: 1rem; margin-right: 1rem;">
              <div class="toggle-option" data-value="true" onclick="toggleReview(this)">YES</div>
              <div class="toggle-option" data-value="false" onclick="toggleReview(this)">NO</div>
            </div>
            <div class="instruction-note" style="flex: 1;">
              Note: If instructor review is selected, the assignment goes to Pending Reviews for approval before posting. If not, the grade and feedback will be auto-posted to the gradebook.
            </div>
          </div>
        </div>

        <div class="row">
          <div class="form-group third">
            <label for="total_points">Total Points</label>
            <input type="number" name="total_points" id="total_points" placeholder="e.g. 60" class="form-control" />
            <div style="margin-top: 0.5rem;">
              <label style="font-size: 0.9rem;">
                <input type="checkbox" id="complete_checkbox" name="complete_incomplete" value="true" onchange="togglePointField()" />
                Grade as Complete/Incomplete
              </label>
            </div>
          </div>

          <div class="form-group third">
            <label for="grade_level">Grade Level</label>
            <select name="grade_level" id="grade_level" class="form-control">
              <option value="">Select Level</option>
              <option value="middle_school">Middle School</option>
              <option value="high_school">High School</option>
              <option value="college">College</option>
            </select>
          </div>

          <div class="form-group third">
            <label for="grading_difficulty">Grading Difficulty</label>
            <select name="grading_difficulty" id="grading_difficulty" class="form-control">
              <option value="">Select Difficulty</option>
              <option value="easy">Easy</option>
              <option value="medium">Medium</option>
              <option value="hard">Hard</option>
            </select>
          </div>
        </div>

        <button type="submit" class="submit">Create Assignment</button>
      </form>
    </div>

    <!-- === TAB 3: Edit NoMas Assignments === -->
    <div id="manage" class="tab-panel card-body">
      <h3 style="margin-bottom: 1rem;">Edit NoMas Assignments</h3>

      <!-- New dynamic list (populated by the script you added) -->
      <section class="nomas-assignments" style="margin:0 auto 1rem; max-width:100%; width:100%;">
        <div id="nomas-assignment-table"></div>
        <p id="nomas-assignment-empty" style="display:none; text-align:center; color:#6b7280;">
          No assignments found.
        </p>
      </section>
    </div>


    <!-- === TAB 4: View NoMas Submissions (NoMas-only) === -->
    <div id="submissions" class="tab-panel card-body">
      <h3 style="margin-bottom: 1rem;">NoMas Submissions</h3>

      {% if submissions %}
      <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem; table-layout: fixed;">
        <thead style="background-color: #f1f1f1;">
          <tr>
            <th style="border: 1px solid #ccc; padding: 0.75rem; width: 15%;">Student</th>
            <th style="border: 1px solid #ccc; padding: 0.75rem; width: 28%;">Assignment</th>
            <th style="border: 1px solid #ccc; padding: 0.75rem; width: 15%;">Form</th>
            <th style="border: 1px solid #ccc; padding: 0.75rem; width: 18%; text-align: center;">Submitted</th>
            <th style="border: 1px solid #ccc; padding: 0.75rem; width: 14%; text-align: center;">Actions</th>
            <th style="border: 1px solid #ccc; padding: 0.75rem; width: 10%;">Notes</th>
          </tr>
        </thead>
        <tbody>
          {% for s in submissions %}
          <tr>
            <td style="border: 1px solid #ccc; padding: 0.75rem; word-wrap: break-word;">{{ s.user_id or s.student_id }}</td>
            <td style="border: 1px solid #ccc; padding: 0.75rem; word-wrap: break-word;">{{ s.assignment_title }}</td>
            <td style="border: 1px solid #ccc; padding: 0.75rem; word-wrap: break-word;">{{ (s.form_type or '')|upper }}</td>
            <td style="border: 1px solid #ccc; padding: 0.75rem; text-align: center; white-space: nowrap;">
              {{ (s.submitted_at or s.submission_time or '')[:19].replace('T',' ') }}
            </td>
            <td style="border: 1px solid #ccc; padding: 0.75rem; text-align: center;">
              <div style="display: flex; flex-direction: column; gap: 0.4rem; align-items: center;">
                <a href="/nomas/review?submission_id={{ s.submission_id }}"
                   style="padding: 0.4rem 0.8rem; background: #1f3a54; color: white; border: none; border-radius: 20px; text-decoration: none; display: inline-block;">
                  Review
                </a>

                <form method="POST" action="/nomas/approve-and-send">
                  <input type="hidden" name="submission_id" value="{{ s.submission_id }}">
                  <button type="submit" style="padding: 0.4rem 0.8rem; background: #16a34a; color: white; border: none; border-radius: 20px;">Accept</button>
                </form>

                <form method="POST" action="/nomas/delete-submission">
                  <input type="hidden" name="submission_id" value="{{ s.submission_id }}">
                  <button type="submit" style="padding: 0.4rem 0.8rem; background: #dc2626; color: white; border: none; border-radius: 20px;">Delete</button>
                </form>
              </div>
            </td>
            <td style="border: 1px solid #ccc; padding: 0.75rem;">
              <form method="POST" action="/nomas/save-notes">
                <input type="hidden" name="submission_id" value="{{ s.submission_id }}">
                <textarea name="instructor_notes" rows="2" style="width: 100%; font-size: 0.9rem; border-radius: 6px; border: 1px solid #ccc;">{{ s.instructor_notes or '' }}</textarea>
                <button type="submit" style="margin-top: 0.5rem; font-size: 0.8rem; background: #888; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 12px;">Save</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p style="color:#777;">No NoMas submissions found.</p>
      {% endif %}
    </div>

  </div> <!-- /.card -->

  <!-- === SCRIPT: Tabs, Prefill, and Helpers (hardened) === -->
  <script>
    // Tabs (robust): remove 'hidden', force inline display, URL param support
    document.addEventListener("DOMContentLoaded", () => {
      try {
        const buttons = document.querySelectorAll(".tab-button");
        const panels  = document.querySelectorAll(".tab-panel");

        // Safety: remove any 'hidden' attribute and normalize visibility
        panels.forEach(p => {
          if (p.hasAttribute("hidden")) p.removeAttribute("hidden");
          p.style.display = p.classList.contains("active") ? "block" : "none";
        });

        function showPanel(targetId) {
          const targetPanel = document.getElementById(targetId);
          if (!targetPanel) return;

          // classes
          buttons.forEach(b => b.classList.toggle("active", b.dataset.target === targetId));
          panels.forEach(p => p.classList.toggle("active", p.id === targetId));

          // visibility hard override
          panels.forEach(p => { p.style.display = (p.id === targetId) ? "block" : "none"; });

          // URL param
          const params = new URLSearchParams(location.search);
          params.set("tab", targetId);
          history.replaceState(null, "", `${location.pathname}?${params.toString()}`);
        }

        function initialTab() {
          const params = new URLSearchParams(location.search);
          const q = params.get("tab");
          const h = location.hash ? location.hash.slice(1) : null;
          return (
            (q && document.getElementById(q) ? q : null) ||
            (h && document.getElementById(h) ? h : null) ||
            (document.querySelector(".tab-button.active")?.dataset.target) ||
            "generate"
          );
        }

        buttons.forEach(btn => btn.addEventListener("click", () => showPanel(btn.dataset.target)));

        // Initial activation
        showPanel(initialTab());

        // üîß Last-resort guard: if submissions is selected but still hidden, force it
        const params = new URLSearchParams(location.search);
        if (params.get("tab") === "submissions") {
          const sub = document.getElementById("submissions");
          if (sub) {
            sub.classList.add("active");
            sub.style.display = "block";
            sub.removeAttribute("hidden");
          }
        }
      } catch (e) {
        console.warn("Tab initializer error:", e);
        const sub = document.getElementById("submissions");
        if (sub) { sub.classList.add("active"); sub.style.display = "block"; sub.removeAttribute("hidden"); }
      }
    });

    // Prefill rubric_url safely
    document.addEventListener("DOMContentLoaded", () => {
      try {
        const params = new URLSearchParams(location.search);
        const rubricUrl = params.get("rubric_url");
        if (!rubricUrl) return;

        const input = document.getElementById("rubric_file_url");
        if (input) {
          input.value = rubricUrl;
          input.readOnly = true;
          input.style.backgroundColor = "#f3f3f3";
        }

        const createForm = document.querySelector("#create form");
        if (createForm && !createForm.querySelector(".rubric-url-banner")) {
          const message = document.createElement("div");
          message.className = "rubric-url-banner";
          message.innerHTML = `<strong>‚úÖ Answer Key Uploaded:</strong> <a href="${rubricUrl}" target="_blank" rel="noopener">${rubricUrl}</a>`;
          createForm.prepend(message);
        }
      } catch (e) {
        console.warn("Prefill script skipped due to error:", e);
      }
    });

    // Toggle for "Requires Instructor Review"
    function toggleReview(button) {
      const container = button?.parentElement;
      if (!container) return;

      const options = container.querySelectorAll(".toggle-option");
      options.forEach(b => {
        b.classList.remove("active");
        b.setAttribute("aria-pressed", "false");
      });

      button.classList.add("active");
      button.setAttribute("aria-pressed", "true");

      const value = button.getAttribute("data-value");
      let hidden = document.getElementById("requiresReviewValue");
      if (!hidden) {
        hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "require_review";
        hidden.id = "requiresReviewValue";
        const createForm = document.querySelector("#create form");
        if (!createForm) return;
        createForm.appendChild(hidden);
      }
      hidden.value = value;
    }

    // Toggle Complete/Incomplete ‚Üí disable/enable points field
    function togglePointField() {
      const checkbox = document.getElementById("complete_checkbox");
      const pointsInput = document.getElementById("total_points");
      if (!checkbox || !pointsInput) return;

      if (checkbox.checked) {
        pointsInput.disabled = true;
        pointsInput.value = "";
      } else {
        pointsInput.disabled = false;
      }
    }

    // Delete assignment with basic error handling
    function deleteUSCISAssignment(assignmentId) {
      if (!assignmentId) return;
      if (!confirm("Are you sure you want to delete this assignment?")) return;

      fetch("/delete-uscis-assignment", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-Requested-With": "fetch" },
        body: JSON.stringify({ assignment_id: assignmentId }),
        credentials: "same-origin"
      })
      .then(res => res.ok ? res.json() : Promise.reject(new Error("Network error")))
      .then(data => {
        if (data && data.success) {
          alert("‚úÖ Assignment deleted.");
          location.reload();
        } else {
          alert("‚ùå Failed to delete assignment.");
        }
      })
      .catch(() => alert("‚ùå Failed to delete assignment (network or server error)."));
    }
  </script>
  <script>
    (function () {
      // Reuse the same endpoint that powers Grader‚Äôs list
      const ENDPOINT = "/grader-assignments";
    
      // Utilities (same behavior as in Grader)
      function escapeAttr(s) { return String(s || "").replace(/"/g, "&quot;"); }
      function getId(a)            { return a.assignment_id ?? a.id ?? a._id ?? null; }
      function getTitle(a)         { return (a.assignment_title || a.title || "").trim(); }
      function getDisplayTitle(a)  { return (a.display_title || a.assignment_title || a.title || "").trim(); }
      function getSlug(a)          { return (a.slug || "").trim(); }
      function getLmsLinkTitle(a)  { return (a.lms_link_title || getDisplayTitle(a)).trim(); }
    
      // Copy helpers (same as Grader page)
      function copyLtiParams(slug, lmsTitle) {
        const lines = [];
        if (slug)     lines.push(`rubiqs_slug=${slug}`);
        if (lmsTitle) lines.push(`rubiqs_link_title=${lmsTitle}`);
        const text = lines.join('\n') || 'rubiqs_slug=\nrubiqs_link_title=';
        navigator.clipboard.writeText(text)
          .then(() => alert('‚úÖ LTI params copied:\n\n' + text))
          .catch(() => window.prompt('Copy these LTI params:', text));
      }
    
      function copyEmbedCode(slug) {
        if (!slug) {
          alert("‚ùå No slug available for this assignment.");
          return;
        }
        const origin = window.location.origin;
        const src = `${origin}/embed/${encodeURIComponent(slug)}`;
        const iframe = `<iframe src="${src}" width="100%" height="640" frameborder="0" allow="clipboard-write; microphone; camera; display-capture; fullscreen" allowfullscreen title="Rubiqs Grader: ${slug}"></iframe>`;
        navigator.clipboard.writeText(iframe)
          .then(() => alert('‚úÖ Embed code copied to clipboard!'))
          .catch(() => window.prompt('Copy this embed code:', iframe));
      }
    
      async function loadNomasAssignments() {
        const wrap   = document.getElementById("nomas-assignment-table");
        const empty  = document.getElementById("nomas-assignment-empty");
        if (!wrap) return;
    
        let assignments = [];
        try {
          const res  = await fetch(ENDPOINT);
          const data = await res.json();
          assignments = Array.isArray(data) ? data : (data.assignments || data.data || []);
        } catch (e) {
          console.error("Failed to fetch assignments:", e);
        }
    
        if (!assignments || assignments.length === 0) {
          if (empty) empty.style.display = "block";
          wrap.innerHTML = "";
          return;
        }
    
        const table = document.createElement("table");
        table.style.width = "100%";
        table.style.borderCollapse = "collapse";
        table.innerHTML = `
          <thead>
            <tr>
              <th style="text-align:left; padding:.5rem;">Title / Slug</th>
              <th>Model</th>
              <th>Points</th>
              <th>Review</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${assignments.map(a => {
              const displayTitle = getDisplayTitle(a);
              const slug         = getSlug(a);
              const lmsTitle     = getLmsLinkTitle(a);
              const edit = (() => {
                const id = getId(a);
                if (id) return `/grader-edit?assignment_id=${encodeURIComponent(id)}`;
                const t  = getTitle(a);
                if (t)  return `/grader-edit?assignment_title=${encodeURIComponent(t)}`;
                return null;
              })();
    
              const titleLink = slug
                ? `<a href="/embed/${encodeURIComponent(slug)}" target="_blank" rel="noopener" style="color:#1f3a54; font-weight:600; text-decoration:none;">${displayTitle || '(untitled)'}</a>`
                : (displayTitle
                    ? `<a href="/student-demo?title=${encodeURIComponent(displayTitle)}" target="_blank" rel="noopener" style="color:#1f3a54; font-weight:600; text-decoration:none;">${displayTitle}</a>`
                    : '(untitled)');
    
              return `
                <tr>
                  <td style="padding:.5rem;">
                    <div style="text-align:left;">
                      <div>${titleLink}</div>
                      <div style="font-size:.85rem; color:#6b7280;">${slug ? 'slug: ' + slug : 'no slug'}</div>
                    </div>
                  </td>
                  <td>${a.gpt_model || '-'}</td>
                  <td>${a.total_points ?? '-'}</td>
                  <td>${a.instructor_approval ? '‚úÖ' : '‚ùå'}</td>
                  <td style="display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap;">
                    ${edit ? `<a class="action-button" style="background:#243b53; color:#fff; padding:.45rem .8rem; border-radius:10px; font-weight:700; text-decoration:none;" href="${edit}">Edit</a>` : `<span style="color:#888;">No ID/Title</span>`}
                    <button class="action-button copy-params" data-slug="${escapeAttr(slug)}" data-lms="${escapeAttr(lmsTitle)}" style="background:#243b53; color:#fff; padding:.45rem .8rem; border-radius:10px; font-weight:700;">Copy Params</button>
                    <button class="action-button copy-embed"  data-slug="${escapeAttr(slug)}" style="background:#243b53; color:#fff; padding:.45rem .8rem; border-radius:10px; font-weight:700;">Copy Embed</button>
                  </td>
                </tr>`;
            }).join("")}
          </tbody>
        `;
    
        wrap.innerHTML = "";
        wrap.appendChild(table);
    
        // Wire copy buttons
        wrap.querySelectorAll(".copy-params").forEach(btn => {
          btn.addEventListener("click", () => {
            const slug = btn.getAttribute("data-slug") || "";
            const lms  = btn.getAttribute("data-lms") || "";
            copyLtiParams(slug, lms);
          });
        });
        wrap.querySelectorAll(".copy-embed").forEach(btn => {
          btn.addEventListener("click", () => {
            const slug = btn.getAttribute("data-slug") || "";
            copyEmbedCode(slug);
          });
        });
      }
    
      // Kick it off when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", loadNomasAssignments);
      } else {
        loadNomasAssignments();
      }
    })();
    </script>
    
</body>


</html>
